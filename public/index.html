<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Captain Talon â€” Eagle Chat</title>

  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 0;
      background: #0b1220;
      color: #eaf2ff;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
      display: grid;
      gap: 16px;
    }

    .card {
      background: #121c33;
      border: 1px solid #243155;
      border-radius: 16px;
      padding: 14px;
    }

    .row {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .row { grid-template-columns: 1fr; }
    }

    #log {
      height: 420px;
      overflow-y: auto;
      padding: 10px;
      background: #0f1730;
      border-radius: 12px;
      border: 1px solid #243155;
    }

    .msg { margin: 10px 0; line-height: 1.35; }
    .me { color: #b8d7ff; }
    .bot { color: #ffe7a6; }
    .label { font-weight: 700; margin-right: 6px; }

    .controls {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      margin-top: 10px;
    }

    input {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #243155;
      background: #0f1730;
      color: #eaf2ff;
    }

    button {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #243155;
      background: #1b2a52;
      color: #eaf2ff;
      cursor: pointer;
    }

    button:hover { filter: brightness(1.08); }

    .eagleBox {
      display: grid;
      gap: 10px;
      justify-items: center;
    }

    .status { font-size: 14px; opacity: .9; }

    .talking {
      animation: pulse 0.6s infinite alternate;
    }

    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.03); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ðŸ¦… Captain Talon â€” Eagle Chat</h1>

    <div class="row">
      <div class="card eagleBox">

        <!-- EAGLE SVG -->
        <svg id="eagle" width="280" height="280" viewBox="0 0 280 280">
          <!-- Body -->
          <circle cx="140" cy="155" r="110" fill="#3c2f24"/>
          <!-- Head -->
          <circle cx="140" cy="110" r="78" fill="#f2f2f2"/>

          <!-- Eyes -->
          <circle cx="110" cy="95" r="10" fill="#111"/>
          <circle cx="170" cy="95" r="10" fill="#111"/>
          <circle cx="113" cy="92" r="3" fill="#fff"/>
          <circle cx="173" cy="92" r="3" fill="#fff"/>

          <!-- Upper Beak -->
          <path
            d="M140 112
               C170 112 195 130 205 152
               C180 160 160 158 140 150
               C120 158 100 160 75 152
               C85 130 110 112 140 112 Z"
            fill="#f0b429"
          />

          <!-- Lower Beak (HINGED) -->
          <g id="lowerBeak"
             style="transform-origin: 140px 150px; transform-box: fill-box;">
            <path
              d="M140 150
                 C164 154 182 164 190 178
                 C168 186 154 184 140 178
                 C126 184 112 186 90 178
                 C98 164 116 154 140 150 Z"
              fill="#d9941e"
            />
          </g>

          <!-- Chest -->
          <ellipse cx="140" cy="195" rx="70" ry="55" fill="#6a4f3b"/>
        </svg>

        <div class="status" id="status">Ready to chat, Little Wing.</div>
      </div>

      <!-- CHAT AREA -->
      <div class="card">
        <div id="log"></div>

        <div class="controls">
          <input id="text" placeholder="Ask Captain Talonâ€¦" />
          <button id="send">Send</button>
          <button id="mute">ðŸ”Š On</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const log = document.getElementById("log");
  const text = document.getElementById("text");
  const sendBtn = document.getElementById("send");
  const muteBtn = document.getElementById("mute");
  const statusEl = document.getElementById("status");
  const eagleSvg = document.getElementById("eagle");
  const lowerBeak = document.getElementById("lowerBeak");

  let muted = false;
  let history = [];
  let talkTimer = null;

  function addMsg(role, content) {
    const div = document.createElement("div");
    div.className = `msg ${role === "user" ? "me" : "bot"}`;
    div.innerHTML = `<span class="label">${role === "user" ? "You:" : "Captain Talon:"}</span>${content}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  async function ask() {
    const q = text.value.trim();
    if (!q) return;

    addMsg("user", q);
    history.push({ role: "user", content: q });
    text.value = "";

    sendBtn.disabled = true;
    statusEl.textContent = "Captain Talon is thinkingâ€¦";

    try {
      const r = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userText: q, history })
      });

      const data = await r.json();
      const reply = data.reply || "Screee!";

      addMsg("assistant", reply);
      history.push({ role: "assistant", content: reply });
      speak(reply);

    } catch {
      addMsg("assistant", "Screeeâ€¦ trouble in the wind!");
    } finally {
      sendBtn.disabled = false;
    }
  }

  sendBtn.onclick = ask;
  text.onkeydown = e => e.key === "Enter" && ask();

  muteBtn.onclick = () => {
    muted = !muted;
    muteBtn.textContent = muted ? "ðŸ”‡ Off" : "ðŸ”Š On";
    speechSynthesis.cancel();
  };

  function speak(text) {
    if (muted || !window.speechSynthesis) return;

    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1.02;
    u.pitch = 0.9;

    u.onstart = startTalking;
    u.onend = stopTalking;

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  function startTalking() {
    statusEl.textContent = "Captain Talon is speakingâ€¦";
    eagleSvg.classList.add("talking");

    let open = false;
    talkTimer = setInterval(() => {
      open = !open;
      lowerBeak.style.transform = open ? "rotate(10deg)" : "rotate(0deg)";
    }, 120);
  }

  function stopTalking() {
    statusEl.textContent = "Ready to chat, Little Wing.";
    eagleSvg.classList.remove("talking");

    clearInterval(talkTimer);
    lowerBeak.style.transform = "rotate(0deg)";
  }

  addMsg("assistant", "Screee! Hello, Little Wing! Ask me about eagles!");
</script>

</body>
</html>
