<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Captain Talon â€” Eagle Chat</title>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background:#0b1220; color:#eaf2ff; }
    .wrap { max-width: 1040px; margin: 0 auto; padding: 18px; display:grid; gap:16px; }
    .card { background:#121c33; border:1px solid #243155; border-radius:16px; padding:14px; }
    .row { display:grid; grid-template-columns: 380px 1fr; gap:16px; }
    @media (max-width:900px){ .row{ grid-template-columns:1fr; } }
    #log { height:440px; overflow-y:auto; padding:10px; background:#0f1730; border-radius:12px; border:1px solid #243155; }
    .msg { margin:10px 0; line-height:1.35; }
    .me{ color:#b8d7ff; } .bot{ color:#ffe7a6; } .label{ font-weight:700; margin-right:6px; }
    .controls{ display:grid; grid-template-columns:1fr auto auto; gap:10px; margin-top:10px; align-items:center; }
    input{ padding:12px; border-radius:12px; border:1px solid #243155; background:#0f1730; color:#eaf2ff; }
    button{ padding:12px 14px; border-radius:12px; border:1px solid #243155; background:#1b2a52; color:#eaf2ff; cursor:pointer; font-weight:600; }
    button:hover{ filter:brightness(1.08); }
    .eagleBox{ display:grid; gap:10px; justify-items:center; align-content:start; }
    .status{ font-size:14px; opacity:.9; text-align:center; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
    .chip{ padding:8px 10px; border-radius:999px; font-size:14px; }

    .idleFloat{ animation: floaty 2.4s ease-in-out infinite; }
    @keyframes floaty{ 0%{transform:translateY(0)} 50%{transform:translateY(-3px)} 100%{transform:translateY(0)} }
    .talkingPulse{ animation: pulse 0.6s infinite alternate; }
    @keyframes pulse{ from{transform:scale(1)} to{transform:scale(1.02)} }

    .lid{ transform-origin:center; transform:scaleY(0); transition:transform 90ms ease-in-out; }
    .blinkNow .lid{ transform:scaleY(1); }
    #lowerBeak{ transition: transform 90ms ease-in-out; }

    .overlay{ position:fixed; inset:0; background:rgba(5,10,20,.78); display:grid; place-items:center; z-index:50; padding:20px; }
    .overlayCard{ max-width:720px; width:100%; background:#121c33; border:1px solid #243155; border-radius:18px; padding:18px; text-align:center; }
    .overlayCard h2{ margin:6px 0 8px; }
    .overlayCard p{ margin:0 0 14px; opacity:.9; }
    .bigBtn{ font-size:18px; padding:14px 18px; border-radius:14px; }
  </style>
</head>

<body>
  <!-- IMPORTANT: inline onclick makes Start work even if event listeners fail -->
  <div id="overlay" class="overlay">
    <div class="overlayCard">
      <h2>ðŸ¦… Start Captain Talon</h2>
      <p>Click Start so the eagle can talk out loud, blink, and make eagle sounds.</p>
      <button id="startBtn" class="bigBtn" onclick="startCaptainTalon()">Start</button>
    </div>
  </div>

  <div class="wrap">
    <h1 style="margin:4px 0 0;">ðŸ¦… Captain Talon â€” Eagle Chat</h1>

    <div class="row">
      <div class="card eagleBox">
        <svg id="eagle" class="idleFloat" width="300" height="300" viewBox="0 0 300 300" aria-label="Talking eagle">
          <circle cx="150" cy="168" r="118" fill="#3c2f24"/>
          <circle cx="150" cy="118" r="84" fill="#f2f2f2"/>

          <circle cx="120" cy="104" r="11" fill="#111"/>
          <circle cx="180" cy="104" r="11" fill="#111"/>
          <circle cx="123" cy="101" r="3.2" fill="#fff"/>
          <circle cx="183" cy="101" r="3.2" fill="#fff"/>

          <g id="blinkGroup">
            <rect class="lid" id="lidL" x="103" y="90" width="34" height="28" rx="12" fill="#f2f2f2"/>
            <rect class="lid" id="lidR" x="163" y="90" width="34" height="28" rx="12" fill="#f2f2f2"/>
          </g>

          <path
            d="M150 120 C182 120 208 140 218 164
               C190 172 168 170 150 162
               C132 170 110 172 82 164
               C92 140 118 120 150 120 Z"
            fill="#f0b429"
          />

          <g id="lowerBeak" style="transform-origin: 150px 162px; transform-box: fill-box;">
            <path
              d="M150 162 C176 166 196 178 205 194
                 C180 204 162 202 150 196
                 C138 202 120 204 95 194
                 C104 178 124 166 150 162 Z"
              fill="#d9941e"
            />
          </g>

          <ellipse cx="150" cy="215" rx="76" ry="60" fill="#6a4f3b" opacity="0.95"/>
        </svg>

        <div class="status" id="status">Click Start to begin, Little Wing.</div>

        <div class="chips">
          <button class="chip" data-q="How high can you fly?">How high can you fly?</button>
          <button class="chip" data-q="How good is your eyesight?">How good is your eyesight?</button>
          <button class="chip" data-q="How big can your nest get?">How big is your nest?</button>
          <button class="chip" data-q="What do you eat?">What do you eat?</button>
        </div>
      </div>

      <div class="card">
        <div id="log" role="log" aria-label="Chat log"></div>

        <div class="controls">
          <input id="text" placeholder='Ask Captain Talonâ€¦ (example: "How high can you fly?")' />
          <button id="send">Send</button>
          <button id="mute">ðŸ”Š On</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const overlay = document.getElementById("overlay");
  const log = document.getElementById("log");
  const text = document.getElementById("text");
  const sendBtn = document.getElementById("send");
  const muteBtn = document.getElementById("mute");
  const statusEl = document.getElementById("status");
  const eagleSvg = document.getElementById("eagle");
  const lowerBeak = document.getElementById("lowerBeak");

  let muted = false;
  let history = [];
  let audioReady = false;

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function addMsg(role, content) {
    const div = document.createElement("div");
    div.className = `msg ${role === "user" ? "me" : "bot"}`;
    div.innerHTML = `<span class="label">${role === "user" ? "You:" : "Captain Talon:"}</span>${escapeHtml(content)}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  // WebAudio screech
  function playScreech() {
    if (!audioReady || muted) return;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    const t = ctx.currentTime;

    o.type = "sawtooth";
    o.frequency.setValueAtTime(900, t);
    o.frequency.exponentialRampToValueAtTime(2300, t + 0.18);
    o.frequency.exponentialRampToValueAtTime(700,  t + 0.55);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.18, t + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.60);

    o.connect(g); g.connect(ctx.destination);
    o.start(t); o.stop(t + 0.62);
    o.onended = () => ctx.close();
  }

  // Blink
  function blinkOnce() {
    eagleSvg.classList.add("blinkNow");
    setTimeout(() => eagleSvg.classList.remove("blinkNow"), 110);
  }
  function startBlinking() {
    const loop = () => {
      const next = 2200 + Math.random() * 2600;
      setTimeout(() => {
        blinkOnce();
        if (Math.random() < 0.18) setTimeout(blinkOnce, 170);
        loop();
      }, next);
    };
    loop();
  }

  // Talking visuals (smooth beak)
  let talkTimer = null;
  let currentOpen = 0;
  let targetOpen = 0;

  function setBeak(deg) {
    lowerBeak.style.transform = `rotate(${deg}deg)`;
  }

  function startTalkingVisuals() {
    statusEl.textContent = "Captain Talon is speakingâ€¦";
    eagleSvg.classList.add("talkingPulse");
    if (talkTimer) clearInterval(talkTimer);

    talkTimer = setInterval(() => {
      const diff = targetOpen - currentOpen;
      currentOpen += diff * 0.35;
      if (Math.abs(diff) < 0.2) currentOpen *= 0.92;
      setBeak(currentOpen);
    }, 60);
  }

  function stopTalkingVisuals() {
    statusEl.textContent = "Ready to chat, Little Wing.";
    eagleSvg.classList.remove("talkingPulse");
    targetOpen = 0;
    currentOpen = 0;
    setBeak(0);
    if (talkTimer) clearInterval(talkTimer);
    talkTimer = null;
  }

  // Speak + word-boundary mouth intensity
  function speak(textToSpeak) {
    if (!audioReady || muted) return;
    if (!("speechSynthesis" in window)) return;

    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(textToSpeak);
    u.rate = 1.02;
    u.pitch = 0.9;

    u.onstart = () => {
      startTalkingVisuals();
      if (Math.random() < 0.35) setTimeout(playScreech, 120);
    };

    u.onboundary = (ev) => {
      if (ev.name !== "word") return;
      const idx = ev.charIndex || 0;
      const slice = textToSpeak.slice(idx, idx + 18);
      const word = (slice.match(/^[A-Za-z']+/) || [""])[0];
      const len = word.length;
      const base = 4;
      const extra = Math.min(10, len);
      const jitter = Math.random() * 2.5;
      targetOpen = base + (extra * 0.7) + jitter; // ~4â€“13deg
    };

    u.onend = () => stopTalkingVisuals();
    u.onerror = () => stopTalkingVisuals();

    window.speechSynthesis.speak(u);
  }

  async function ask() {
    const q = text.value.trim();
    if (!q) return;

    addMsg("user", q);
    history.push({ role: "user", content: q });
    text.value = "";

    sendBtn.disabled = true;
    statusEl.textContent = "Captain Talon is thinkingâ€¦";

    try {
      const r = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userText: q, history })
      });

      const data = await r.json();
      if (!r.ok) throw new Error(data.error || "Request failed");

      const reply = data.reply || "Screee! My eagle words drifted away!";
      addMsg("assistant", reply);
      history.push({ role: "assistant", content: reply });
      speak(reply);
      if (Math.random() < 0.40) setTimeout(playScreech, 650);

    } catch (e) {
      addMsg("assistant", "Screeeâ€¦ I canâ€™t reach my nest server right now. (Try again!)");
      console.error(e);
      statusEl.textContent = "Connection trouble.";
      stopTalkingVisuals();
    } finally {
      sendBtn.disabled = false;
    }
  }

  sendBtn.addEventListener("click", ask);
  text.addEventListener("keydown", (e) => { if (e.key === "Enter") ask(); });

  muteBtn.addEventListener("click", () => {
    muted = !muted;
    muteBtn.textContent = muted ? "ðŸ”‡ Off" : "ðŸ”Š On";
    if ("speechSynthesis" in window) window.speechSynthesis.cancel();
    stopTalkingVisuals();
  });

  document.querySelectorAll("button[data-q]").forEach(btn => {
    btn.addEventListener("click", () => {
      text.value = btn.getAttribute("data-q");
      ask();
    });
  });

  // IMPORTANT: Global function so inline onclick works
  window.startCaptainTalon = function startCaptainTalon() {
    console.log("Start clicked!");
    overlay.style.display = "none";               // you should SEE this immediately
    statusEl.textContent = "Started! Little Wing, Iâ€™m ready.";

    audioReady = true;
    startBlinking();

    const intro = "Screee! This is an awesome presentation, Austin! Iâ€™m Captain Talon, a majestic bald eagle. Ask me anything about eagles, flying, nests, and natureâ€”Little Wing!";
    addMsg("assistant", intro);
    history.push({ role: "assistant", content: intro });

    // Try speech + sound (if iframe blocks it, youâ€™ll still see overlay disappear)
    try { speak(intro); } catch {}
    setTimeout(() => { try { playScreech(); } catch {} }, 900);
  };

  addMsg("assistant", "Screee! Click Start so I can talk out loud, Little Wing!");
</script>
</body>
</html>
